name: Deploy to VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Sync files to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          source: "."
          target: "${{ secrets.REMOTE_PATH || '/opt/pact-website' }}"
          overwrite: true
          rm: false
          strip_components: 0
          exclude: |
            .git
            node_modules
            dist
            .env
            .github

      - name: Write env file on VPS
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            cd ${{ secrets.REMOTE_PATH || '/opt/pact-website' }}
            
            # Generate random session secret if .env doesn't exist
            if [ ! -f ".env" ]; then
              SESSION_SECRET=$(openssl rand -base64 32 | tr -dc 'a-zA-Z0-9')
              
              cat > .env << EOF
            # Database
            DATABASE_URL=postgresql://neondb_owner:npg_aTqvez1r0bkA@ep-holy-sea-ahwpuzyd-pooler.c-3.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require
            
            # Session Secret (generate a secure random string)
            SESSION_SECRET=${SESSION_SECRET}
            
            # Frontend API proxy URL
            VITE_API_URL=http://138.68.104.122:8080
            EOF
            fi

      - name: Build and restart app
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || '22' }}
          script: |
            cd ${{ secrets.REMOTE_PATH || '/opt/pact-website' }}
            docker compose -f docker-compose.prod.yml down
            docker compose -f docker-compose.prod.yml build --pull
            docker compose -f docker-compose.prod.yml up -d
